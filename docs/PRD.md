# 티켓 발권 백엔드 PRD

## 1. 제품 개요
- 목적: “자유석” 기준의 간단한 발권 API와 환불 API 2종을 제공한다.
- 범위: 극장명, 영화명, 가격(통화: KRW)을 입력받아 발권(티켓 생성) 및 환불 처리. 데이터는 로컬 SQLite(`data/app.db`)에 저장한다.
- 제외: 좌석 위치/배치, 좌석 홀드/경합 제어, 결제(PG) 연동, 사용자 인증, 다중 통화.

### 1.1 배경
- 기존 카탈로그 서비스가 제공하는 영화관/영화/가격 정보를 읽어 프론트가 발권 요청을 보낸다.
- 초기 PoC 단계에서 영속성 계층은 로컬 SQLite 데이터베이스로 구성한다.

### 1.2 용어
- 티켓(Ticket): 자유석 1건의 발권 레코드. 수량이 2장이면 2개의 티켓을 생성한다.
- 환불(Refund): 발권된 티켓을 취소하는 행위. 부분 환불은 비범위.

## 2. 주요 사용자
- 내부 프론트엔드/운영 도구: 발권/환불을 요청하고 상태를 조회.
- 운영자: 장애 시 재시도·로그 확인, 데이터 검증.

## 3. 성공 지표
- 발권/환불 요청 성공률 ≥ 99.9%
- 데이터 손실 0건
- 평균 응답 시간 200ms 내(로컬 기준)

## 4. 핵심 기능
- 발권(티켓 생성) API 제공
- 환불(티켓 취소) API 제공
- 티켓 조회 API 제공 (단일 조회 및 목록 조회)
- SQLite 기반 영속화(`data/app.db`), 장애 시 재시작해도 데이터 유지
- 간단한 멱등성(선택)과 감사 가능성 확보

## 5. 사용자 시나리오
1) 발권
   - 입력: 극장명, 영화명, 가격(KRW), 수량(기본 1), 메모(선택),
   - 결과: 티켓 ID 목록 반환. 파일에 영구 저장.
2) 환불
   - 입력: 티켓 ID(들), 이유(선택)
   - 결과: 해당 티켓 상태가 canceled로 변경되고 환불 시각 기록.
3) 티켓 조회
   - 단일 조회: 티켓 ID로 특정 티켓의 상세 정보 조회
   - 목록 조회: 극장명, 영화명, 상태 등 필터 조건으로 티켓 목록 조회

## 6. 요구 사항
### 6.1 기능 요구사항
- 발권
  - 극장명/영화명/가격이 유효하면 티켓을 생성한다.
  - 기본 수량 1, 수량 N이면 N개의 고유 티켓 생성.
  - 응답에 생성된 티켓들의 ID와 요약 반환.
- 환불
  - 존재하고 refundable 상태(issued)인 티켓만 취소 가능.
  - 이미 취소된 티켓을 재요청 시 안전하게 무해(idempotent-like) 처리.

### 6.2 데이터 요구사항
- 저장소: `data/app.db` (SQLite)
- 테이블(개략):
  - tickets
    - id(TEXT, PK), theater_name(TEXT), movie_title(TEXT), price_krw(INTEGER), status(TEXT: issued|canceled), memo(TEXT, NULLABLE)
- 제약
  - id는 전역 고유
  - price_krw는 정수(원 단위)

### 6.3 에러/상태코드
- 201 Created: 발권 성공
- 200 OK: 환불 성공, 조회 성공
- 400 Bad Request: 필드 누락/유효성 오류
- 404 Not Found: 존재하지 않는 티켓(환불 또는 조회 시)
- 409 Conflict: 상이한 요청 재시도
- 500 Internal Server Error: DB 쓰기 실패 등

### 6.4 비기능 요구사항
- 성능: 단일 인스턴스 기준 초당 수십 RPS 처리(SQLite, 단일 커넥션 풀)
- 신뢰성: 트랜잭션 기반 쓰기, 실패 시 롤백
- 보안: PII 저장하지 않음. 서버 내 파일 권한 제한.
- 멱등성: `Idempotency-Key` 헤더(선택)로 동일 요청 재시 응답 재사용
 - 실행 표준: 콘솔 스크립트(`movie-ticket-backend`)로 애플리케이션을 실행 가능해야 함

## 7. 범위 및 제외
- 포함: 자유석 기준 발권/환불, 멱등성(선택), 감사 로그
- 제외: 좌석 배치/경합, 결제 연동, 인증/권한, 다중 통화

## 8. API 문서/실행
- 서버 실행: `python app.py`
- 바인드: `0.0.0.0:9000`
- Swagger UI: `http://localhost:9090/docs`
- OpenAPI JSON: `http://localhost:9090/openapi.json`
 - CLI 실행 표준:
   - 콘솔 스크립트: `movie-ticket-backend` (우선 실행 진입점)
   - 실행 예시: `uv run movie-ticket-backend`

